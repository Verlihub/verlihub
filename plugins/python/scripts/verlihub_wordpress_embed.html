<!-- Verlihub Dashboard WordPress Embed -->
<!-- Paste this entire snippet into a WordPress Custom HTML block or page editor -->
<!-- Make sure to update the API_BASE_URL to point to your Verlihub API endpoint -->

<style>
    .vh-dashboard-wrapper { font-family: Arial, sans-serif; max-width: 1024px; margin: 0 auto; padding: 20px; background: #f9f9f9; border-radius: 8px; }
    .vh-tabs { margin-bottom: 20px; position: relative; z-index: 100; }
    .vh-tab { cursor: pointer; display: inline-block; padding: 10px 15px; background: #eee; border: 1px solid #ccc; margin-right: 5px; border-radius: 5px 5px 0 0; position: relative; z-index: 101; }
    .vh-tab.active { background: #fff; border-bottom: none; font-weight: bold; }
    .vh-content { padding: 20px; border: 1px solid #ccc; border-radius: 0 5px 5px 5px; background: #fff; min-height: 300px; position: relative; z-index: 1; }
    .vh-content::before {
        content: "Loading...";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.2em;
        color: #666;
        display: none;
        z-index: 10;
    }
    .vh-content.loading::before { display: block; }
    .vh-content.loading > * { opacity: 0.3; pointer-events: none; }
    .vh-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    .vh-table th, .vh-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    .vh-table th { background: #f5f5f5; font-size: 1em; cursor: pointer; user-select: none; }
    .vh-table th:hover { background: #e9e9e9; }
    .vh-table tr:nth-child(even) { background: #fafafa; }
    .vh-table tr.update-highlight {
        background: #ffffd0 !important;
        animation: vh-highlightFade 4s ease-out forwards;
    }
    @keyframes vh-highlightFade {
        0%   { background: #ffffd0 !important; }
        50%  { background: #ffffd0 !important; }
        100% { background: transparent; }
    }
    .vh-link { color: #0066cc; text-decoration: none; }
    .vh-link:hover { text-decoration: underline; }
    .vh-user-detail { position: fixed; top: 15%; left: 15%; width: 70%; max-height: 70%; overflow-y: auto; background: #fff; border: 1px solid #aaa; padding: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.3); display: none; z-index: 10000; border-radius: 8px; }
    .vh-user-detail button { float: right; padding: 8px 12px; cursor: pointer; background: #0066cc; color: white; border: none; border-radius: 4px; }
    .vh-user-detail button:hover { background: #0052a3; }
    .vh-user-detail h2 { margin-top: 0; color: #333; }
    .vh-user-detail h3 { color: #333; border-bottom: 2px solid #0066cc; padding-bottom: 8px; margin-top: 25px; margin-bottom: 15px; }
    .vh-user-detail h3:first-of-type { margin-top: 10px; }
    .vh-info-list { list-style: none; padding: 0; margin: 15px 0; }
    .vh-info-list li { margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
    .vh-flag { font-size: 2em; text-align: center; }
    .vh-count { text-align: center; font-weight: bold; font-size: 1.2em; }
    .vh-total-countries { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; }
    .vh-total-users { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; }
    .vh-hub-topic { font-size: 1.4em; font-weight: bold; margin: 0 0 30px 0; text-align: center; }
    .vh-hub-upper { display: flex; flex-wrap: wrap; gap: 30px; align-items: flex-start; margin-bottom: 30px; justify-content: center; }
    .vh-hub-logo-wrapper { 
        flex: 0 0 auto; 
        text-align: center; 
        width: 256px; 
        height: 256px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
    }
    .vh-hub-logo img { 
        max-width: 256px; 
        max-height: 256px; 
        width: auto; 
        height: auto; 
        border-radius: 8px; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
        display: block;
    }
    .vh-hub-info { flex: 1 1 300px; }
    .vh-motd-wrapper { text-align: center; margin-top: 20px; }
    .vh-motd { background: #f0f0f0; padding: 15px; border-radius: 8px; display: inline-block; text-align: left; }
    .vh-motd pre { margin: 0; white-space: pre-wrap; font-family: monospace; font-size: 0.95em; }
    .vh-sort-arrow { margin-left: 6px; opacity: 0.5; }
    .vh-sort-arrow.active { opacity: 1; font-weight: bold; }
    
    @media (max-width: 768px) {
        .vh-dashboard-wrapper { padding: 10px; }
        .vh-user-detail { top: 5%; left: 5%; width: 90%; max-height: 85%; }
    }
</style>

<div class="vh-dashboard-wrapper">
    <div class="vh-tabs" id="vh-tabs">
        <span class="vh-tab active" data-tab="hub">Hub</span>
        <span class="vh-tab" data-tab="users">Online Users</span>
        <span class="vh-tab" data-tab="geo">Geography</span>
    </div>
    <div class="vh-content" id="vh-content">Loading...</div>
</div>

<div class="vh-user-detail" id="vh-user-detail">
    <button onclick="vhCloseUserDetail()">Close Ã—</button>
    <h2>User Details</h2>
    <div id="vh-user-content"></div>
</div>

<script>
(function() {
    'use strict';
    
    // *** CONFIGURATION: Update this to your Verlihub API endpoint ***
    const API_BASE = 'https://wintermute.sublevels.net/verlihub-api';
    // Example: const API_BASE = 'https://hub.example.com/verlihub-api';
    
    let currentTab = 'hub';
    let pollInterval;
    let currentUsers = [];
    let currentGeo = [];
    let lastHubHtml = '';
    let lastUsersHtml = '';
    let lastGeoHtml = '';
    let isFirstLoad = { users: true, geo: true };

    const sortState = {
        users: { key: 'share', asc: false },
        geo: { key: 'users', asc: false }
    };

    function fetchData(endpoint) {
        return fetch(API_BASE + endpoint)
            .then(res => {
                if (!res.ok) throw new Error(`HTTP ${res.status} - ${res.statusText}`);
                return res.json();
            });
    }

    function formatBytes(bytes) {
        if (bytes === undefined || bytes === null) return 'N/A';
        const units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
        let i = 0;
        while (bytes >= 1024 && i < units.length - 1) {
            bytes /= 1024;
            i++;
        }
        return `${bytes.toFixed(2)} ${units[i]}`;
    }

    function getFlagEmoji(cc) {
        if (!cc || cc.length !== 2) return 'ðŸŒ';
        return String.fromCodePoint(...[...cc.toUpperCase()].map(c => 0x1F1E6 + c.charCodeAt(0) - 65));
    }

    function renderKeyValue(obj, excludeKeys = [], renameMap = {}) {
        if (!obj || typeof obj !== 'object') return '<p>No data available</p>';
        let html = '<ul class="vh-info-list">';
        for (const [key, value] of Object.entries(obj)) {
            if (excludeKeys.includes(key)) continue;
            let displayKey = renameMap[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            let formattedValue = value ?? 'N/A';
            if (typeof value === 'number' && (key.toLowerCase().includes('share') || key.toLowerCase().includes('size'))) {
                formattedValue = formatBytes(value);
            } else if (typeof value === 'string') {
                formattedValue = value.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            }
            html += `<li><strong>${displayKey}:</strong> ${formattedValue}</li>`;
        }
        html += '</ul>';
        return html;
    }

    function renderUsersTable(rows) {
        const userCount = rows.length;
        if (userCount === 0) return '<p>No users currently online</p>';

        const sortedRows = [...rows].sort((a, b) => {
            let aVal, bVal;
            switch (sortState.users.key) {
                case 'nick':
                    aVal = (a.nick || a.Nick || '').toString().toLowerCase();
                    bVal = (b.nick || b.Nick || '').toString().toLowerCase();
                    return sortState.users.asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                case 'class':
                    aVal = (a.class_name || a.class || a.Class || '').toString();
                    bVal = (b.class_name || b.class || b.Class || '').toString();
                    return sortState.users.asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                case 'country':
                    aVal = (a.country_code || a.country || a.cc || a.CC || '').toUpperCase();
                    bVal = (b.country_code || b.country || b.cc || b.CC || '').toUpperCase();
                    return sortState.users.asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                case 'share':
                default:
                    aVal = Number(a.share_size || a.share || a.Share || 0);
                    bVal = Number(b.share_size || b.share || b.Share || 0);
                    return sortState.users.asc ? aVal - bVal : bVal - aVal;
            }
        });

        let html = `<div class="vh-total-users">Online users: ${userCount}</div>`;
        html += '<table class="vh-table"><thead><tr>';
        const headers = [
            { text: 'Nick', key: 'nick' },
            { text: 'Class', key: 'class' },
            { text: 'Country', key: 'country' },
            { text: 'Share', key: 'share' }
        ];

        headers.forEach(h => {
            const arrow = sortState.users.key === h.key 
                ? (sortState.users.asc ? 'â†‘' : 'â†“') 
                : 'â†•';
            html += `<th onclick="vhSetSort('users', '${h.key}')">${h.text} <span class="vh-sort-arrow ${sortState.users.key === h.key ? 'active' : ''}">${arrow}</span></th>`;
        });
        html += '</tr></thead><tbody>';

        sortedRows.forEach(row => {
            const nick = (row.nick || row.Nick || 'Unknown').toString();
            const prevUser = currentUsers.find(u => (u.nick || u.Nick || '').toString() === nick);
            const shareChanged = prevUser && Number(row.share_size || row.share || row.Share || 0) !== Number(prevUser.share_size || prevUser.share || prevUser.Share || 0);
            const isNew = !prevUser;

            const shouldHighlight = !isFirstLoad.users && (isNew || shareChanged);
            const highlightClass = shouldHighlight ? ' update-highlight' : '';

            const className = row.class_name || row.class || row.Class || 'N/A';
            const countryCode = row.country_code || row.country || row.Country || row.cc || row.CC || '';
            const shareBytes = Number(row.share_size || row.share || row.Share || 0);

            html += `<tr class="${highlightClass}">`;
            html += `<td><a href="#" class="vh-link" onclick="vhShowUser('${encodeURIComponent(nick)}'); return false;">${nick}</a></td>`;
            html += `<td>${className}</td>`;
            html += `<td><span class="vh-flag">${getFlagEmoji(countryCode)}</span></td>`;
            html += `<td>${formatBytes(shareBytes)}</td>`;
            html += '</tr>';
        });

        html += '</tbody></table>';

        currentUsers = [...rows];
        isFirstLoad.users = false;

        return html;
    }

    function renderGeo(data) {
        if (!data || !Array.isArray(data.distribution)) return '<p>No geographic data available</p>';

        const totalCountries = data.total_countries || data.distribution.length;

        const sortedDist = [...data.distribution].sort((a, b) => {
            if (sortState.geo.key === 'country') {
                return sortState.geo.asc 
                    ? a.country_code.localeCompare(b.country_code)
                    : b.country_code.localeCompare(a.country_code);
            } else {
                return sortState.geo.asc ? a.users - b.users : b.users - a.users;
            }
        });

        let html = `<div class="vh-total-countries">Total countries represented: ${totalCountries}</div>`;
        html += '<table class="vh-table"><thead><tr>';
        
        const geoHeaders = [
            { text: 'Flag', key: 'country' },
            { text: 'Users', key: 'users' }
        ];

        geoHeaders.forEach(h => {
            const arrow = sortState.geo.key === h.key 
                ? (sortState.geo.asc ? 'â†‘' : 'â†“') 
                : 'â†•';
            html += `<th onclick="vhSetSort('geo', '${h.key}')">${h.text} <span class="vh-sort-arrow ${sortState.geo.key === h.key ? 'active' : ''}">${arrow}</span></th>`;
        });

        html += '</tr></thead><tbody>';
        for (const item of sortedDist) {
            const prev = currentGeo.find(g => g.country_code === item.country_code);
            const changed = prev && prev.users !== item.users;
            const isNew = !prev;

            const shouldHighlight = !isFirstLoad.geo && (isNew || changed);
            const highlightClass = shouldHighlight ? ' update-highlight' : '';

            const flag = getFlagEmoji(item.country_code);
            html += `<tr class="${highlightClass}"><td class="vh-flag">${flag}</td><td class="vh-count">${item.users}</td></tr>`;
        }
        html += '</tbody></table>';

        currentGeo = [...data.distribution];
        isFirstLoad.geo = false;

        return html;
    }

    window.vhSetSort = function(tab, key) {
        if (sortState[tab].key === key) {
            sortState[tab].asc = !sortState[tab].asc;
        } else {
            sortState[tab].key = key;
            sortState[tab].asc = (tab === 'geo' && key === 'users') || (tab === 'users' && key === 'share') ? false : true;
        }
        loadTab(currentTab);
    };

    async function loadTab(tab) {
        const isTabSwitch = (currentTab !== tab);
        currentTab = tab;
        
        document.querySelectorAll('.vh-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.vh-tab[data-tab="${tab}"]`).classList.add('active');

        const contentEl = document.getElementById('vh-content');
        contentEl.classList.add('loading');

        try {
            let html = '';
            let shouldUpdate = true;

            switch (tab) {
                case 'hub':
                    try {
                        const [hubData, shareData, statsData] = await Promise.all([
                            fetchData('/hub'),
                            fetchData('/share'),
                            fetchData('/stats')
                        ]);

                        const logoUrl = hubData.logo_url || hubData.LogoUrl || '';
                        const hasLogo = logoUrl && logoUrl.trim() !== '';
                        const motd = hubData.motd || hubData.Motd || '';
                        const topic = (hubData.topic || hubData.Topic || '').trim();

                        html += `<div class="vh-hub-topic">${topic || 'No topic set'}</div>`;

                        html += '<div class="vh-hub-upper">';
                        if (hasLogo) {
                            html += `<div class="vh-hub-logo-wrapper"><div class="vh-hub-logo"><img src="${logoUrl}" alt="Hub Logo" onerror="this.style.display='none'"></div></div>`;
                        }
                        html += '<div class="vh-hub-info">';

                        const hubExclude = ['name', 'Name', 'description', 'Description', 'logo_url', 'LogoUrl', 'motd', 'Motd', 'topic', 'Topic', 'icon_url', 'IconUrl', 'icon', 'Icon'];
                        html += renderKeyValue(hubData, hubExclude);

                        const shareRename = {
                            total_formatted: 'Total Share',
                            average_formatted: 'Average Share',
                            total: 'Total Share',
                            average: 'Average Share'
                        };
                        html += renderKeyValue(shareData, ['total', 'average'], shareRename);

                        const liveStats = {
                            Timestamp: statsData.timestamp || statsData.Timestamp || 'N/A',
                            'Users Online': statsData.users_online || statsData.users || statsData.UsersOnline || 'N/A'
                        };
                        html += renderKeyValue(liveStats);

                        html += '</div></div>';

                        if (motd && motd.trim() !== '') {
                            html += '<div class="vh-motd-wrapper"><div class="vh-motd"><pre>' + motd.trim() + '</pre></div></div>';
                        }

                        lastHubHtml = html;
                    } catch (hubError) {
                        console.error('Hub tab error:', hubError);
                        html = `<p style="color:red;">Error loading hub data: ${hubError.message}</p>`;
                    }
                    break;
                    
                case 'users':
                    let response = await fetchData('/users?limit=500');
                    let rows = [];
                    if (Array.isArray(response)) rows = response;
                    else if (response && response.users && Array.isArray(response.users)) rows = response.users;
                    else if (response && response.data && Array.isArray(response.data)) rows = response.data;

                    html = renderUsersTable(rows);

                    if (html === lastUsersHtml) {
                        shouldUpdate = false;
                    } else {
                        lastUsersHtml = html;
                    }
                    break;
                    
                case 'geo':
                    const geoData = await fetchData('/geo');
                    html = renderGeo(geoData);

                    if (html === lastGeoHtml) {
                        shouldUpdate = false;
                    } else {
                        lastGeoHtml = html;
                    }
                    break;
            }

            if (shouldUpdate || isTabSwitch) {
                contentEl.innerHTML = html;
                void contentEl.offsetHeight;
            }

            contentEl.classList.remove('loading');

        } catch (err) {
            contentEl.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
            contentEl.classList.remove('loading');
            console.error('API error:', err);
        }
    }

    window.vhShowUser = async function(encodedNick) {
        const nick = decodeURIComponent(encodedNick);
        try {
            const data = await fetchData(`/user/${encodedNick}`);
            
            const fieldRenames = {
                nick: 'Nickname',
                class_name: 'User Class',
                ip: 'IP Address',
                host: 'Hostname',
                country_code: 'Country Code',
                country: 'Country',
                city: 'City',
                region: 'Region/State',
                region_code: 'Region Code',
                timezone: 'Time Zone',
                continent: 'Continent',
                continent_code: 'Continent Code',
                postal_code: 'Postal Code',
                asn: 'ASN',
                hub_url: 'Hub URL',
                ext_json: 'Extensions',
                description: 'Description',
                tag: 'Client Tag',
                email: 'Email',
                share: 'Share Size'
            };
            
            const basicInfo = {};
            const geoInfo = {};
            const connectionInfo = {};
            const otherInfo = {};
            
            const geoFields = ['country_code', 'country', 'city', 'region', 'region_code', 
                               'timezone', 'continent', 'continent_code', 'postal_code', 'asn'];
            const connectionFields = ['ip', 'host', 'hub_url'];
            const basicFields = ['nick', 'class', 'class_name', 'description', 'tag', 'email', 'share'];
            
            for (const [key, value] of Object.entries(data)) {
                if (key === 'share_formatted') continue;
                
                if (geoFields.includes(key) && value && value !== '' && value !== 'N/A') {
                    geoInfo[key] = value;
                } else if (connectionFields.includes(key) && value && value !== '') {
                    connectionInfo[key] = value;
                } else if (basicFields.includes(key)) {
                    basicInfo[key] = value;
                } else if (value && value !== '' && value !== 'N/A') {
                    otherInfo[key] = value;
                }
            }
            
            let html = '';
            
            if (Object.keys(basicInfo).length > 0) {
                html += '<h3>Basic Information</h3>';
                html += renderKeyValue(basicInfo, [], fieldRenames);
            }
            
            if (Object.keys(geoInfo).length > 0) {
                html += '<h3>Geographic Information</h3>';
                if (geoInfo.country_code) {
                    html += `<div style="text-align: center; font-size: 3em; margin: 10px 0;">${getFlagEmoji(geoInfo.country_code)}</div>`;
                }
                html += renderKeyValue(geoInfo, [], fieldRenames);
            }
            
            if (Object.keys(connectionInfo).length > 0) {
                html += '<h3>Connection Information</h3>';
                html += renderKeyValue(connectionInfo, [], fieldRenames);
            }
            
            if (Object.keys(otherInfo).length > 0) {
                html += '<h3>Additional Information</h3>';
                html += renderKeyValue(otherInfo, [], fieldRenames);
            }
            
            document.getElementById('vh-user-content').innerHTML = html;
            document.getElementById('vh-user-detail').style.display = 'block';
        } catch (err) {
            alert(`Failed to load user ${nick}: ${err.message}`);
        }
    };

    window.vhCloseUserDetail = function() {
        document.getElementById('vh-user-detail').style.display = 'none';
    };

    // Tab click handlers
    document.querySelectorAll('.vh-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            loadTab(tab.dataset.tab);
        });
    });

    // Auto-refresh every 30 seconds
    function startPolling() {
        if (pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(() => loadTab(currentTab), 30000);
    }

    // Initialize
    loadTab('hub');
    startPolling();
})();
</script>
