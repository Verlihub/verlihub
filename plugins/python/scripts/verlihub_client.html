<!DOCTYPE html>
<html lang="en">
<head>
    <title id="page-title">Verlihub Dashboard</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
        #tabs { margin-bottom: 20px; }
        .tab { cursor: pointer; display: inline-block; padding: 10px 15px; background: #eee; border: 1px solid #ccc; margin-right: 5px; border-radius: 5px 5px 0 0; }
        .tab.active { background: #fff; border-bottom: none; font-weight: bold; }
        #content { padding: 20px; border: 1px solid #ccc; border-radius: 0 5px 5px 5px; background: #fff; min-height: 300px; position: relative; }
        #content::before {
            content: "Loading...";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            color: #666;
            display: none;
            z-index: 10;
        }
        #content.loading::before { display: block; }
        #content.loading > * { opacity: 0.3; pointer-events: none; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f5f5f5; font-size: 1em; cursor: pointer; user-select: none; }
        th:hover { background: #e9e9e9; }
        tr:nth-child(even) { background: #fafafa; }
        tr.update-highlight {
            background: #ffffd0 !important;
            animation: highlightFade 4s ease-out forwards;
        }
        @keyframes highlightFade {
            0%   { background: #ffffd0 !important; }
            50%  { background: #ffffd0 !important; }
            100% { background: transparent; }
        }
        a { color: #0066cc; text-decoration: none; }
        a:hover { text-decoration: underline; }
        #user-detail { position: fixed; top: 15%; left: 15%; width: 70%; max-height: 70%; overflow-y: auto; background: #fff; border: 1px solid #aaa; padding: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.3); display: none; z-index: 1000; border-radius: 8px; }
        #user-detail button { float: right; padding: 8px 12px; cursor: pointer; }
        .info-list { list-style: none; padding: 0; margin: 15px 0; }
        .info-list li { margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        .flag { font-size: 2em; text-align: center; }
        .count { text-align: center; font-weight: bold; font-size: 1.2em; }
        .total-countries { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; }
        .total-users { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; }
        .hub-topic { font-size: 1.4em; font-weight: bold; margin: 0 0 20px 0; text-align: center; }
        .hub-main { display: flex; flex-wrap: wrap; gap: 30px; align-items: flex-start; }
        .hub-left { flex: 1 1 300px; }
        .hub-right { flex: 0 1 250px; text-align: center; }
        .hub-logo img { max-width: 200px; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .motd { background: #f0f0f0; padding: 15px; border-radius: 8px; margin-top: 30px; }
        .motd pre { margin: 0; white-space: pre-wrap; font-family: monospace; font-size: 0.95em; }
        .sort-arrow { margin-left: 6px; opacity: 0.5; }
        .sort-arrow.active { opacity: 1; font-weight: bold; }
        .page-header { text-align: center; margin-bottom: 20px; }
        .hub-name { font-size: 2em; margin: 0; }
        .hub-desc { font-size: 1.1em; color: #555; margin: 10px 0 0 0; }
    </style>
</head>
<body>
    <div class="page-header">
        <h1 id="hub-name-header" class="hub-name">Verlihub Dashboard</h1>
        <p id="hub-desc-header" class="hub-desc"></p>
    </div>

    <div id="tabs">
        <span class="tab active" data-tab="hub">Hub</span>
        <span class="tab" data-tab="users">Online Users</span>
        <span class="tab" data-tab="geo">Geography</span>
    </div>
    <div id="content">Loading...</div>

    <div id="user-detail">
        <button onclick="closeUserDetail()">Close Ã—</button>
        <h2>User Details</h2>
        <div id="user-content"></div>
    </div>

    <script>
        const API_BASE = '/verlihub-api';

        let currentTab = 'hub';
        let pollInterval;
        let currentUsers = [];
        let currentGeo = [];
        let isFirstLoad = { users: true, geo: true };

        const sortState = {
            users: { key: 'share', asc: false },
            geo: { key: 'users', asc: false }
        };

        function fetchData(endpoint) {
            return fetch(API_BASE + endpoint)
                .then(res => {
                    if (!res.ok) throw new Error(`HTTP ${res.status} - ${res.statusText}`);
                    return res.json();
                });
        }

        function formatBytes(bytes) {
            if (bytes === undefined || bytes === null) return 'N/A';
            const units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return `${bytes.toFixed(2)} ${units[i]}`;
        }

        function getFlagEmoji(cc) {
            if (!cc || cc.length !== 2) return 'ðŸŒ';
            return String.fromCodePoint(...[...cc.toUpperCase()].map(c => 0x1F1E6 + c.charCodeAt(0) - 65));
        }

        function renderKeyValue(obj, excludeKeys = [], renameMap = {}) {
            if (!obj || typeof obj !== 'object') return '<p>No data available</p>';
            let html = '<ul class="info-list">';
            for (const [key, value] of Object.entries(obj)) {
                if (excludeKeys.includes(key)) continue;
                let displayKey = renameMap[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                let formattedValue = value ?? 'N/A';
                if (typeof value === 'number' && (key.toLowerCase().includes('share') || key.toLowerCase().includes('size'))) {
                    formattedValue = formatBytes(value);
                }
                html += `<li><strong>${displayKey}:</strong> ${formattedValue}</li>`;
            }
            html += '</ul>';
            return html;
        }

        function renderUsersTable(rows) {
            const userCount = rows.length;
            if (userCount === 0) return '<p>No users currently online</p>';

            const sortedRows = [...rows].sort((a, b) => {
                let aVal, bVal;
                switch (sortState.users.key) {
                    case 'nick':
                        aVal = (a.nick || a.Nick || '').toString().toLowerCase();
                        bVal = (b.nick || b.Nick || '').toString().toLowerCase();
                        return sortState.users.asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    case 'class':
                        aVal = (a.class_name || a.class || a.Class || '').toString();
                        bVal = (b.class_name || b.class || b.Class || '').toString();
                        return sortState.users.asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    case 'country':
                        aVal = (a.country_code || a.country || a.cc || a.CC || '').toUpperCase();
                        bVal = (b.country_code || b.country || b.cc || b.CC || '').toUpperCase();
                        return sortState.users.asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    case 'share':
                    default:
                        aVal = Number(a.share_size || a.share || a.Share || 0);
                        bVal = Number(b.share_size || b.share || b.Share || 0);
                        return sortState.users.asc ? aVal - bVal : bVal - aVal;
                }
            });

            let html = `<div class="total-users">Online users: ${userCount}</div>`;
            html += '<table id="users-table"><thead><tr>';
            const headers = [
                { text: 'Nick', key: 'nick' },
                { text: 'Class', key: 'class' },
                { text: 'Country', key: 'country' },
                { text: 'Share', key: 'share' }
            ];

            headers.forEach(h => {
                const arrow = sortState.users.key === h.key 
                    ? (sortState.users.asc ? 'â†‘' : 'â†“') 
                    : 'â†•';
                html += `<th onclick="setSort('users', '${h.key}')">${h.text} <span class="sort-arrow ${sortState.users.key === h.key ? 'active' : ''}">${arrow}</span></th>`;
            });
            html += '</tr></thead><tbody>';

            sortedRows.forEach(row => {
                const nick = (row.nick || row.Nick || 'Unknown').toString();
                const prevUser = currentUsers.find(u => (u.nick || u.Nick || '').toString() === nick);
                const shareChanged = prevUser && Number(row.share_size || row.share || row.Share || 0) !== Number(prevUser.share_size || prevUser.share || prevUser.Share || 0);
                const isNew = !prevUser;

                const shouldHighlight = !isFirstLoad.users && (isNew || shareChanged);
                const highlightClass = shouldHighlight ? ' update-highlight' : '';

                const className = row.class_name || row.class || row.Class || 'N/A';
                const countryCode = row.country_code || row.country || row.Country || row.cc || row.CC || '';
                const shareBytes = Number(row.share_size || row.share || row.Share || 0);

                html += `<tr class="${highlightClass}">`;
                html += `<td><a href="#" onclick="showUser('${encodeURIComponent(nick)}'); return false;">${nick}</a></td>`;
                html += `<td>${className}</td>`;
                html += `<td><span class="flag">${getFlagEmoji(countryCode)}</span></td>`;
                html += `<td>${formatBytes(shareBytes)}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';

            currentUsers = [...rows];
            isFirstLoad.users = false;

            return html;
        }

        function renderGeo(data) {
            if (!data || !Array.isArray(data.distribution)) return '<p>No geographic data available</p>';

            const totalCountries = data.total_countries || data.distribution.length;

            const sortedDist = [...data.distribution].sort((a, b) => {
                if (sortState.geo.key === 'country') {
                    return sortState.geo.asc 
                        ? a.country_code.localeCompare(b.country_code)
                        : b.country_code.localeCompare(a.country_code);
                } else {
                    return sortState.geo.asc ? a.users - b.users : b.users - a.users;
                }
            });

            let html = `<div class="total-countries">Total countries represented: ${totalCountries}</div>`;
            html += '<table id="geo-table"><thead><tr>';
            
            const geoHeaders = [
                { text: 'Flag', key: 'country' },
                { text: 'Users', key: 'users' }
            ];

            geoHeaders.forEach(h => {
                const arrow = sortState.geo.key === h.key 
                    ? (sortState.geo.asc ? 'â†‘' : 'â†“') 
                    : 'â†•';
                html += `<th onclick="setSort('geo', '${h.key}')">${h.text} <span class="sort-arrow ${sortState.geo.key === h.key ? 'active' : ''}">${arrow}</span></th>`;
            });

            html += '</tr></thead><tbody>';
            for (const item of sortedDist) {
                const prev = currentGeo.find(g => g.country_code === item.country_code);
                const changed = prev && prev.users !== item.users;
                const isNew = !prev;

                const shouldHighlight = !isFirstLoad.geo && (isNew || changed);
                const highlightClass = shouldHighlight ? ' update-highlight' : '';

                const flag = getFlagEmoji(item.country_code);
                html += `<tr class="${highlightClass}"><td class="flag">${flag}</td><td class="count">${item.users}</td></tr>`;
            }
            html += '</tbody></table>';

            currentGeo = [...data.distribution];
            isFirstLoad.geo = false;

            return html;
        }

        function setSort(tab, key) {
            if (sortState[tab].key === key) {
                sortState[tab].asc = !sortState[tab].asc;
            } else {
                sortState[tab].key = key;
                sortState[tab].asc = (tab === 'geo' && key === 'users') || (tab === 'users' && key === 'share') ? false : true;
            }
            loadTab(currentTab);
        }

        async function loadTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');

            const contentEl = document.getElementById('content');

            if (contentEl.innerHTML.trim() === '' || contentEl.innerHTML === 'Loading...') {
                contentEl.innerHTML = 'Loading...';
                contentEl.classList.add('loading');
            } else {
                contentEl.classList.add('loading');
            }

            try {
                let html = '';
                switch (tab) {
                    case 'hub':
                        const [hubData, shareData, statsData] = await Promise.all([
                            fetchData('/hub'),
                            fetchData('/share'),
                            fetchData('/stats')
                        ]);

                        // Set page title and header
                        const hubName = (hubData.name || hubData.Name || '').trim() || 'Unknown Hub';
                        const hubDesc = (hubData.description || hubData.Description || '').trim();
                        document.getElementById('page-title').textContent = hubName;
                        document.getElementById('hub-name-header').textContent = hubName;
                        document.getElementById('hub-desc-header').textContent = hubDesc;

                        const logoUrl = hubData.logo_url || hubData.LogoUrl || '';
                        const hasLogo = logoUrl && logoUrl.trim() !== '';
                        const motd = hubData.motd || hubData.Motd || '';
                        const topic = (hubData.topic || hubData.Topic || '').trim();

                        // Topic at the top
                        html += `<div class="hub-topic">${topic || 'No topic set'}</div>`;

                        html += '<div class="hub-main">';
                        html += '<div class="hub-left">';

                        // Hub info (exclude name, description, logo_url, motd, topic, icon_url)
                        const hubExclude = ['name', 'Name', 'description', 'Description', 'logo_url', 'LogoUrl', 'motd', 'Motd', 'topic', 'Topic', 'icon_url', 'IconUrl', 'icon', 'Icon'];
                        html += renderKeyValue(hubData, hubExclude);

                        // Share data
                        const shareRename = {
                            total_formatted: 'Total Share',
                            average_formatted: 'Average Share',
                            total: 'Total Share',
                            average: 'Average Share'
                        };
                        html += renderKeyValue(shareData, ['total', 'average'], shareRename);

                        // Live stats
                        const liveStats = {
                            Timestamp: statsData.timestamp || statsData.Timestamp || 'N/A',
                            'Users Online': statsData.users_online || statsData.users || statsData.UsersOnline || 'N/A'
                        };
                        html += renderKeyValue(liveStats);

                        html += '</div>'; // .hub-left

                        html += '<div class="hub-right">';
                        if (hasLogo) {
                            html += `<div class="hub-logo"><img src="${logoUrl}" alt="Hub Logo" onerror="this.style.display='none'"></div>`;
                        }
                        html += '</div>'; // .hub-right

                        html += '</div>'; // .hub-main

                        // MOTD last
                        if (motd && motd.trim() !== '') {
                            html += '<div class="motd"><pre>' + motd.trim() + '</pre></div>';
                        }

                        break;
                    case 'users':
                        let response = await fetchData('/users?limit=500');
                        let rows = [];
                        if (Array.isArray(response)) rows = response;
                        else if (response && response.users && Array.isArray(response.users)) rows = response.users;
                        else if (response && response.data && Array.isArray(response.data)) rows = response.data;
                        html = renderUsersTable(rows);
                        break;
                    case 'geo':
                        const geoData = await fetchData('/geo');
                        html = renderGeo(geoData);
                        break;
                }

                contentEl.innerHTML = html;
                contentEl.classList.remove('loading');

                void contentEl.offsetHeight;

            } catch (err) {
                contentEl.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
                contentEl.classList.remove('loading');
                console.error('API error:', err);
            }
        }

        async function showUser(encodedNick) {
            const nick = decodeURIComponent(encodedNick);
            try {
                const data = await fetchData(`/user/${encodedNick}`);
                document.getElementById('user-content').innerHTML = renderKeyValue(data);
                document.getElementById('user-detail').style.display = 'block';
            } catch (err) {
                alert(`Failed to load user ${nick}: ${err.message}`);
            }
        }

        function closeUserDetail() {
            document.getElementById('user-detail').style.display = 'none';
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                loadTab(tab.dataset.tab);
            });
        });

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(() => loadTab(currentTab), 30000);
        }

        loadTab('hub');
        startPolling();
    </script>
</body>
</html>